<h1 class="text-3xl tracking-wide text-center">
  CanoÃ« Flights
</h1>
<div class="p-4 m-2 rounded-lg bg-blue-950 text-white">
  <h2 class="text-xl font-semibold mb-4">Flight Results for</h2>
  <div class="flex">
    <h3><%= @departure_city %> - <%= @arrival_city %></h3>
    <% if @return_date %>
      <h3 class="mx-8"><%= @departure_date.strftime('%a, %B %d') %> - <%= @return_date.strftime('%a, %B %d') %></h3>
    <% else %>
      <h3 class="mx-8"><%= @departure_date.strftime('%a, %B %d') %></h3>
    <% end %>
    <h3 class="mx-8"><%= @adults %> adults</h3>
    <h3 class="mx-8"><%= @travel_class.capitalize %></h3>
  </div>
</div>
<% @flights.each do |flight| %>
  <div class="flight-details bg-white rounded-lg mx-64 my-8 py-4 px-4">
    <% flight['itineraries'].each do |itinerary| %>
      <div class="itinerary">
        <% segments = itinerary['segments'] %>
        <% if segments %>
          <% operating_airline_codes = segments.map { |segment| segment['operating']&.dig('carrierCode') }.compact.uniq %>
          <% operating_airlines = operating_airline_codes.map { |code| search_airlines_name(code, @access_token) } %>
          <% flight_price = flight['price'] %>
          <% segments.each do |segment| %>
            <% if segment['operating'] && segment['operating']['carrierCode'] %>
              <!-- Flight info -->
              <div class="flight-info">
                <p>
                  <strong><%= Time.parse(segment['departure']['at']).strftime('%H:%M') %> -</strong>
                  <small><%= itinerary['duration'].strip[2..-1].downcase %></small> - ðŸ›¬
                  <strong><%= Time.parse(segment['arrival']['at']).strftime('%H:%M') %></strong>
                </p>
                <p>
                  <%= segment['departure']['iataCode'] %> - <%= segment['arrival']['iataCode'] %>
                </p>
                <%# Check Airline Operating the flights %>
                <% if operating_airlines.size == 1 %>
                  <p class="text-sm mb-4">
                    Flights operated by <strong><%= operating_airlines.first %></strong>
                  </p>
                <% elsif operating_airlines.size > 1 %>
                  <p class="text-sm mb-4">
                    Flights operated by several airlines
                  </p>
                <% else %>
                  <p class="text-sm mb-4">
                    Main operating airline is <%= operating_airlines.join(' ') %>
                  </p>
                <% end %>
                <%# Check if baggage is included %>
                <% fare_details = flight['travelerPricings']&.[](0)&['fareDetailsBySegment']&.find { |fare| fare && fare['segmentId'] == segment['id'] } %>
                <% if fare_details && fare_details['includedCheckedBags'] %>
                  <p class="text-sm mb-4">
                    Baggage included: <%= fare_details['includedCheckedBags']['quantity'] %> checked bags
                  </p>
                <% elsif flight['pricingOptions'] && flight['pricingOptions']['includedCheckedBagsOnly'] == true %>
                  <p class="text-sm mb-4">
                    ðŸ§³ included
                  </p>
                <% else %>
                  <p class="text-sm mb-4">
                    ðŸ§³ information not available
                  </p>
                <% end %>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <!-- Price display -->
    <p class="mt-4">
      <strong><%= flight['price'] %>â‚¬</strong>
    </p>
  </div>
<% end %>
